<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ditto WebRTC Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        video {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 5px;
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button.connect {
            background: #4CAF50;
            color: white;
        }
        button.connect:hover {
            background: #45a049;
        }
        button.disconnect {
            background: #f44336;
            color: white;
        }
        button.disconnect:hover {
            background: #da190b;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }
        .status.connecting {
            background: #fff3e0;
            color: #ef6c00;
        }
        .status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 Ditto Talking Head - WebRTC Client</h1>

        <div class="video-container">
            <div>
                <h3>Local Video (You)</h3>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div>
                <h3>Remote Video (Ditto Bot)</h3>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>

        <div class="controls">
            <button id="connectBtn" class="connect">Connect</button>
            <button id="disconnectBtn" class="disconnect" disabled>Disconnect</button>
        </div>

        <div id="status" class="status disconnected">
            Status: Disconnected
        </div>

        <div class="log" id="log">
            <div class="log-entry">Ready to connect...</div>
        </div>
    </div>

    <script>
        let peerConnection = null;
        let localStream = null;
        let pcId = null;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');

        // ICE servers configuration
        const iceServers = [
            { urls: 'stun:stun.l.google.com:19302' }
        ];

        function log(message) {
            console.log(message);
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(status, className) {
            statusDiv.textContent = `Status: ${status}`;
            statusDiv.className = `status ${className}`;
        }

        async function getLocalMedia() {
            try {
                log('Requesting microphone and camera access...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true
                });
                localVideo.srcObject = localStream;
                log('✅ Got local media stream');
                return true;
            } catch (err) {
                log(`❌ Error getting local media: ${err.message}`);
                alert('Failed to get camera/microphone access. Please allow permissions.');
                return false;
            }
        }

        async function connect() {
            updateStatus('Connecting...', 'connecting');
            connectBtn.disabled = true;

            // Get local media first
            if (!localStream) {
                const success = await getLocalMedia();
                if (!success) {
                    updateStatus('Disconnected', 'disconnected');
                    connectBtn.disabled = false;
                    return;
                }
            }

            // Create peer connection
            log('Creating RTCPeerConnection...');
            peerConnection = new RTCPeerConnection({ iceServers });

            // Add local stream tracks
            localStream.getTracks().forEach(track => {
                log(`Adding ${track.kind} track to peer connection`);
                peerConnection.addTrack(track, localStream);
            });

            // Handle remote tracks
            peerConnection.ontrack = (event) => {
                log(`Received remote ${event.track.kind} track`);
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    log(`ICE candidate: ${event.candidate.type}`);
                }
            };

            // Handle ICE connection state changes
            peerConnection.oniceconnectionstatechange = () => {
                log(`ICE connection state: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    updateStatus('Connected', 'connected');
                    disconnectBtn.disabled = false;
                } else if (peerConnection.iceConnectionState === 'failed') {
                    updateStatus('Connection Failed', 'disconnected');
                    log('❌ ICE connection failed');
                }
            };

            // Handle connection state changes
            peerConnection.onconnectionstatechange = () => {
                log(`Connection state: ${peerConnection.connectionState}`);
            };

            // Create and send offer
            try {
                log('Creating offer...');
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                log('Local description set');

                // Send offer to server
                log('Sending offer to server...');
                const response = await fetch('/api/offer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sdp: offer.sdp,
                        type: offer.type,
                        pc_id: pcId
                    })
                });

                const answer = await response.json();
                pcId = answer.pc_id;
                log(`Received answer from server (pc_id: ${pcId})`);

                // Set remote description
                await peerConnection.setRemoteDescription({
                    type: answer.type,
                    sdp: answer.sdp
                });
                log('✅ Remote description set - connection established!');

            } catch (err) {
                log(`❌ Error during connection: ${err.message}`);
                updateStatus('Connection Failed', 'disconnected');
                connectBtn.disabled = false;
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
            }
        }

        function disconnect() {
            log('Disconnecting...');

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            localVideo.srcObject = null;
            remoteVideo.srcObject = null;

            pcId = null;

            updateStatus('Disconnected', 'disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;

            log('✅ Disconnected');
        }

        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);

        log('Client ready. Click "Connect" to start.');
    </script>
</body>
</html>
